---
// GreetingSection.astro - Carousel-optimized with better mobile scroll

interface Props {
  layout: "teacher" | "generation";
  name: string;
  title: string;
  greeting: string;
  photo: string;
  backgroundImage: string;
  schoolLogo?: string;
  disableBackground?: boolean;
  excerptLength?: number;
}

const {
  layout,
  name,
  title,
  greeting,
  photo,
  backgroundImage,
  schoolLogo,
  disableBackground = false,
  excerptLength = 300,
} = Astro.props;

const excerpt =
  greeting.length > excerptLength
    ? greeting.slice(0, excerptLength).trim() + "..."
    : greeting;

const hasMore = greeting.length > excerptLength;
const sectionId = `greeting-${name.toLowerCase().replace(/\s+/g, "-")}`;

const isTeacherLayout = layout === "teacher";
const imageFloat = isTeacherLayout ? "lg:float-right" : "lg:float-left";
const imageMargin = isTeacherLayout ? "lg:ml-8 lg:mr-0" : "lg:mr-8 lg:ml-0";
const textAlign = isTeacherLayout ? "text-right" : "text-left";

const fadeDirection = isTeacherLayout
  ? `background: linear-gradient(to right,
            transparent,
            rgb(var(--color-primary) / 40%),
            rgb(var(--color-primary))
          );`
  : `background: linear-gradient(to left,
            transparent,
            rgb(var(--color-primary) / 40%),
            rgb(var(--color-primary))
          );`;

const overlayDirection = isTeacherLayout
  ? "bg-gradient-to-r from-black/50 via-black/30 to-black/20"
  : "bg-gradient-to-l from-black/50 via-black/30 to-black/20";
---

<section
  class="relative min-h-screen py-20 sm:py-28 md:py-36 lg:py-44
         flex items-center overflow-hidden"
  data-greeting
  data-bg-image={backgroundImage}
>
  <!-- Background Image -->
  {
    !disableBackground && (
      <div
        class="absolute inset-0 bg-cover bg-center bg-no-repeat"
        style={`background-image: url('${backgroundImage}');`}
      >
        <div class="absolute z-10 inset-0" style={fadeDirection} />
        <div class={"absolute z-10 inset-0 " + overlayDirection} />

        {isTeacherLayout && schoolLogo && (
          <div
            class="absolute aspect-square right-12 top-8 w-2xs md:top-16 
                       md:right-38 lg:right-8 xl:right-16 md:w-md p-3 z-5"
          >
            <img
              src={schoolLogo}
              alt="School Logo"
              class="w-full h-full object-contain opacity-75"
              loading="lazy"
            />
          </div>
        )}
      </div>
    )
  }

  <!-- Content Container -->
  <div class="relative z-15 container-custom px-4 sm:px-6 lg:px-8 w-full">
    <div class="max-w-screen mx-4 md:mx-16 text-white">
      <!-- Image Float -->
      <div
        class={`
          greeting-image-float
          relative mb-8 lg:mb-0
          mx-auto lg:mx-0
          w-64 sm:w-72 md:w-80 lg:w-96
          ${imageFloat}
          ${imageMargin}
        `}
        data-layout={layout}
      >
        <div class="relative">
          <div class="aspect-3/4 overflow-hidden z-10">
            <img
              src={photo}
              alt={`Photo of ${name}`}
              class="w-full h-full object-cover"
              loading="lazy"
            />
          </div>

          <div
            class="absolute -top-4 -left-4 w-8 h-8 bg-accent-300
                      rounded-full opacity-80 animate-pulse"
          >
          </div>
          <div
            class="absolute top-1/2 -right-6 w-4 h-4 bg-white
                      rounded-full opacity-60 animate-pulse"
            style="animation-delay: 1s;"
          >
          </div>
        </div>
      </div>

      <!-- Text Content -->
      <div class={textAlign}>
        <!-- Header -->
        <div class="space-y-3 mb-6">
          <p
            class="text-sm font-medium text-accent-300 uppercase tracking-wider"
          >
            Sambutan
          </p>

          <h2
            class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl
                     font-heading font-bold leading-tight"
          >
            {name}
          </h2>

          <h3
            class="text-base sm:text-lg md:text-xl font-medium
                     text-white/80 uppercase tracking-wide"
          >
            {title}
          </h3>

          <div class="flex items-center gap-4 pt-2">
            <div class="w-12 sm:w-16 h-px bg-accent-300"></div>
            <div class="w-2 h-2 bg-accent-300 rounded-full"></div>
            <div class="w-12 sm:w-16 h-px bg-accent-300"></div>
          </div>
        </div>

        <!-- ✅ Greeting Text with Smart Mobile Scroll -->
        <div class="greeting-text-wrapper">
          <!-- ✅ Scroll Container (Mobile Only) -->
          <div
            class="greeting-text-content
                      max-h-[60vh] md:max-h-none
                      overflow-y-auto md:overflow-visible
                      scrollbar-custom"
          >
            <!-- Quote Icon -->
            <svg
              class="w-10 h-10 md:w-12 md:h-12 text-accent-200/40 mb-4
                     float-left mr-4 mt-2"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"
              ></path>
            </svg>

            <!-- Excerpt -->
            <div id={`${sectionId}-excerpt`}>
              <div
                class="text-lg sm:text-xl md:text-2xl leading-relaxed
                          text-white/90 italic whitespace-pre-line"
              >
                {excerpt}
              </div>
            </div>

            <!-- Full Text -->
            {
              hasMore && (
                <div id={`${sectionId}-full`} class="hidden">
                  <div
                    class="text-lg sm:text-xl md:text-2xl leading-relaxed 
                            text-white/90 italic whitespace-pre-line"
                  >
                    {greeting}
                  </div>
                </div>
              )
            }

            <!-- ✅ Scroll Hint (Mobile Only) -->
            <div class="scroll-hint hidden">
              <svg
                class="w-5 h-5 animate-bounce"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
              </svg>
              <span class="text-xs">Scroll untuk baca lebih lanjut</span>
            </div>
          </div>

          <!-- Read More Button -->
          {
            hasMore && (
              <div class="clear-both pt-6">
                <button
                  id={`${sectionId}-toggle`}
                  type="button"
                  class="group inline-flex items-center gap-2 px-6 py-3 
                       bg-white/10 backdrop-blur-md hover:bg-white/20 
                       text-white font-medium rounded-lg 
                       border border-white/30 hover:border-white/50
                       transition-all duration-300 shadow-lg
                       hover:shadow-xl hover:scale-105
                       focus:outline-none focus:ring-2 focus:ring-white/50 
                       focus:ring-offset-2 focus:ring-offset-black/20"
                  data-section-id={sectionId}
                  aria-expanded="false"
                >
                  <span class="toggle-text">Read More</span>
                  <svg
                    class="w-5 h-5 transition-transform duration-300 toggle-icon"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
              </div>
            )
          }

          <!-- Signature -->
          <div class={`clear-both pt-8 ${textAlign}`}>
            <div class="text-accent-200 font-medium text-base">
              — {name}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating decorative elements -->
  <div
    class="absolute top-10 left-10 w-3 h-3 bg-accent-300 rounded-full
              opacity-40 animate-pulse"
  >
  </div>
  <div
    class="absolute bottom-20 right-20 w-2 h-2 bg-white rounded-full
              opacity-50 animate-pulse"
    style="animation-delay: 1.5s;"
  >
  </div>
  <div
    class="absolute top-1/3 right-10 w-1 h-1 bg-accent-200 rounded-full
              opacity-30 animate-pulse"
    style="animation-delay: 0.5s;"
  >
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const toggleButtons = document.querySelectorAll("[data-section-id]");

    const isDesktop = window.matchMedia("(min-width: 768px)").matches;

    toggleButtons.forEach((button) => {
      const sectionId = button.getAttribute("data-section-id");
      const excerptEl = document.getElementById(`${sectionId}-excerpt`);
      const fullTextEl = document.getElementById(`${sectionId}-full`);
      const toggleText = button.querySelector(".toggle-text");
      const toggleIcon = button.querySelector(".toggle-icon");
      const scrollHint = button
        .closest(".greeting-text-wrapper")
        ?.querySelector(".scroll-hint");

      let isExpanded = false;

      button.addEventListener("click", () => {
        const section = button.closest("[data-greeting]");
        if (!section) return;

        const isExpanded = (section as HTMLElement).dataset.expanded === "true";

        if (!isExpanded) {
          excerptEl?.classList.add("hidden");
          fullTextEl?.classList.remove("hidden");

          (section as HTMLElement).dataset.expanded = "true";

          if (toggleText) toggleText.textContent = "Read Less";
          toggleIcon?.classList.add("rotate-180");
          button.setAttribute("aria-expanded", "true");

          if (scrollHint && !isDesktop) scrollHint.classList.remove("hidden");
        } else {
          excerptEl?.classList.remove("hidden");
          fullTextEl?.classList.add("hidden");

          delete (section as HTMLElement).dataset.expanded;

          if (toggleText) toggleText.textContent = "Read More";
          toggleIcon?.classList.remove("rotate-180");
          button.setAttribute("aria-expanded", "false");

          if (scrollHint) scrollHint.classList.add("hidden");

          section.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });

    // ✅ Hide scroll hint after user scrolls
    const textContents = document.querySelectorAll(".greeting-text-content");
    textContents.forEach((content) => {
      const scrollHint = content.querySelector(".scroll-hint");
      if (!scrollHint) return;

      content.addEventListener(
        "scroll",
        () => {
          if (content.scrollTop > 20) {
            scrollHint.classList.add("opacity-0");
          } else {
            scrollHint.classList.remove("opacity-0");
          }
        },
        { passive: true }
      );
    });
  });
</script>

<style>
  /* ===== Text Wrap (Desktop) ===== */
  @media (min-width: 1024px) {
    .greeting-image-float {
      shape-outside: margin-box;
      shape-margin: 2rem;
    }
  }

  @media (max-width: 1023px) {
    .greeting-image-float {
      float: none !important;
      margin-left: auto !important;
      margin-right: auto !important;
    }
  }

  /* ===== Text Content ===== */
  .greeting-text-content {
    text-align: justify;
    hyphens: auto;
    position: relative;
  }

  @media (max-width: 768px) {
    .greeting-text-content {
      hyphens: none;

      /* ✅ Better scrollbar styling */
      padding-right: 8px;
    }
  }

  /* ===== Custom Scrollbar ===== */
  .scrollbar-custom {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
  }

  .scrollbar-custom::-webkit-scrollbar {
    width: 6px;
  }

  .scrollbar-custom::-webkit-scrollbar-track {
    background: transparent;
  }

  .scrollbar-custom::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
  }

  .scrollbar-custom::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }

  /* ===== Scroll Hint ===== */
  .scroll-hint {
    position: sticky;
    bottom: 0;
    left: 0;
    right: 0;

    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;

    padding: 12px;
    margin-top: 16px;

    background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.5));

    color: rgba(255, 255, 255, 0.7);
    text-align: center;

    pointer-events: none;
    transition: opacity 300ms ease;
  }

  .scroll-hint.hidden,
  .scroll-hint.opacity-0 {
    opacity: 0;
  }

  /* ===== Float & Transitions ===== */
  .clear-both {
    clear: both;
  }

  .toggle-icon {
    transition: transform 0.3s ease;
  }

  svg.float-left {
    shape-outside: circle(50%);
  }

  /* ===== Smooth Opacity Transitions ===== */
  #greeting-excerpt > div,
  #greeting-full > div {
    transition: opacity 0.3s ease-in-out;
  }

  .whitespace-pre-line {
    white-space: pre-line;
  }

  /* ===== Button Effects ===== */
  button[data-section-id] {
    position: relative;
    overflow: hidden;
  }

  button[data-section-id]::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    transform: translate(-50%, -50%);
    transition:
      width 0.6s,
      height 0.6s;
  }

  button[data-section-id]:hover::before {
    width: 300px;
    height: 300px;
  }
</style>
